<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
    body {
      margin: 0;
    }
    canvas {
      width: 100%;
      height: 100%;
    }
    .output {
      position: absolute;
      height: 100px;
      line-height: 100px;
      vertical-align: middle;
      text-align: center;
      font-family: Helvetica, Arial;
      font-size: 24pt;
      color: white;
      border: 1px solid lightgray;
      box-sizing: border-box;
    }
    #logger {
      width: 100%;
      cursor: pointer;
    }
    #counter {
      width: 280px;
    }
    @media (max-width: 800px) {
      .output {
        height: 50px;
        line-height: 50px;
        font-size: 13pt;
      }
      #counter {
        width: 100px;
      }
    }
    </style>
  </head>
  <body>
    <div id="logger" class="output"></div>
    <div id="counter" class="output" contenteditable>300</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r79/three.min.js"></script>
    <script>
    (function() {
      'use strict';

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(
        75, window.innerWidth / window.innerHeight, 0.1, 1000);
      var renderer = new THREE.WebGLRenderer();
      var geometry = new THREE.CylinderGeometry(2, 2, 2, 64);
      var material = new THREE.MeshBasicMaterial({
        color: 0x00ff00,
        wireframe: true
      });
      var cylinder = new THREE.Mesh(geometry, material);
      var webglCanvas = null;
      var vrDisplay = null;
      var logger = document.getElementById('logger');
      var counter = document.getElementById('counter');

      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);
      scene.add(cylinder);
      camera.position.z = 5;
      renderer.render(scene, camera);
      webglCanvas = renderer.domElement;
      logger.addEventListener('click', requestPresent, false);

      if (navigator.getVRDisplays) {
        navigator.getVRDisplays()
        .then(function(displays) {
          if (displays.length > 0) {
            vrDisplay = displays[displays.length - 1];
            log('Enter VR');
          } else {
            log('No VR display');
          }
        }, function() {
          log('getVRDisplays failed');
        });
      } else {
        log('VR not supported');
      }

      function requestPresent() {
        if (vrDisplay) {
          if (vrDisplay.capabilities.canPresent) {
            vrDisplay.requestPresent([{source: webglCanvas}])
            .then(function() {
              vrDisplay.requestAnimationFrame(onAnimationFrame);
            }, function() {
              log('requestPresent failed');
            });
          } else {
            log('!canPresent');
          }
        } else {
          window.requestAnimationFrame(onAnimationFrame);
        }
      }

      function onAnimationFrame() {
        if (countDown()) {
          cylinder.rotation.x += 0.03;
          cylinder.rotation.y += 0.03;
          renderer.render(scene, camera);
          if (vrDisplay) {
            vrDisplay.requestAnimationFrame(onAnimationFrame);
            if (vrDisplay.isPresenting) {
              vrDisplay.submitFrame();
            }
          } else {
            window.requestAnimationFrame(onAnimationFrame);
          }
        } else {
          if (vrDisplay) {
            vrDisplay.exitPresent()
            .then(function() {
            }, function() {
              log('exitPresent failed');
            });
          }
        }
      }

      function log(comment) {
        logger.textContent = comment;
      }

      function countDown() {
        var count = +counter.textContent;
        if (count > 0) {
          counter.textContent = --count;
          return true;
        }
        counter.textContent = 0;
        return false;
      }
    })();
    </script>
  </body>
</html>
