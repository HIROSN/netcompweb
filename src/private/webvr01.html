<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
    body {
      margin: 0;
      overflow: hidden;
    }
    .output, .fail {
      position: absolute;
      height: 100px;
      line-height: 100px;
      vertical-align: middle;
      text-align: center;
      font-family: Helvetica, Arial;
      font-size: 24pt;
      color: white;
      border: 1px solid lightgray;
      box-sizing: border-box;
    }
    .fail {
      color: red;
    }
    #logger {
      width: 100%;
      cursor: pointer;
    }
    #counter {
      width: 280px;
    }
    @media (max-width: 800px) {
      .output, .fail {
        height: 50px;
        line-height: 50px;
        font-size: 13pt;
      }
      #counter {
        width: 100px;
      }
    }
    </style>
    <script>
    var WebVRConfig = {
      FORCE_ENABLE_VR: true,
      MOUSE_KEYBOARD_CONTROLS_DISABLED: true,
      DEFER_INITIALIZATION: true
    };
    </script>
    <script src="webvr-polyfill.min.js"></script>
    <script src="three/three.min.js"></script>
  </head>
  <body>
    <div id="logger" class="output">Animate</div>
    <div id="counter" class="output" contenteditable>300</div>
    <script>
    (function() {
      'use strict';

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(
        70, window.innerWidth / window.innerHeight, 0.1, 10);
      var room = new THREE.Mesh(
        new THREE.BoxGeometry(6, 6, 6, 8, 8, 8),
        new THREE.MeshBasicMaterial({
          color: 0x404040,
          wireframe: true
        })
      );
      var cylinder = new THREE.Mesh(
        new THREE.CylinderGeometry(2, 2, 2, 64),
        new THREE.MeshBasicMaterial({
          color: 0x00ff00,
          wireframe: true
        })
      );
      var renderer = new THREE.WebGLRenderer({antialias: true});
      var webglCanvas = null;
      var vrDisplay = null;
      var usePolyfill = !navigator.getVRDisplays;
      var logger = document.getElementById('logger');
      var counter = document.getElementById('counter');

      webglCanvas = renderer.domElement;
      document.body.appendChild(webglCanvas);
      room.add(cylinder);
      scene.add(room);
      resize();
      render();

      logger.addEventListener('click', requestPresent, false);
      window.addEventListener('resize', resize, false);
      window.addEventListener('keydown', onKeyDown, false);

      if (usePolyfill) {
        InitializeWebVRPolyfill();
      }
      initVR();

      function initVR() {
        if (navigator.getVRDisplays) {
          navigator.getVRDisplays()
          .then(function(displays) {
            if (displays.length > 0) {
              vrDisplay = displays[displays.length - 1];
              log('Enter VR');
            } else {
              log('Fail: No VR display');
            }
          }, function() {
            log('getVRDisplays failed');
          });
        } else {
          log('Failed to initialize polyfill');
        }
      }

      function requestPresent() {
        if (vrDisplay) {
          if (vrDisplay.capabilities.canPresent) {
            vrDisplay.requestPresent([{source: webglCanvas}])
            .then(function() {
              vrDisplay.requestAnimationFrame(onAnimationFrame);
            }, function() {
              log('requestPresent failed');
            });
          } else {
            log('Fail: !canPresent');
          }
        } else {
          window.requestAnimationFrame(onAnimationFrame);
        }
      }

      function onAnimationFrame() {
        if (countDown()) {
          cylinder.rotation.x += 0.01;
          cylinder.rotation.y += 0.01;
          render();
          if (vrDisplay) {
            if (vrDisplay.isPresenting) {
              vrDisplay.submitFrame();
            }
            vrDisplay.requestAnimationFrame(onAnimationFrame);
          } else {
            window.requestAnimationFrame(onAnimationFrame);
          }
        } else {
          if (vrDisplay) {
            vrDisplay.exitPresent()
            .then(function() {
            }, function() {
              log('exitPresent failed');
            });
          }
        }
      }

      function position() {
        cylinder.position.set(0, 0, -5);
        var pose = {};
        if (vrDisplay) {
          var frameData = null;
          if (vrDisplay.getFrameData) {
            vrDisplay.getFrameData(frameData);
          }
          if (frameData) {
            pose = frameData.pose;
          } else if (vrDisplay.getPose) {
            pose = vrDisplay.getPose();
          }
        }
        if (pose.orientation) {
          camera.quaternion.fromArray(pose.orientation);
        }
        if (pose.position) {
          camera.position.fromArray(pose.position);
        } else {
          camera.position.set(0, 0, 0);
        }
      }

      function render() {
        position();
        renderer.render(scene, camera);
      }

      function resize() {
        var width = window.innerWidth;
        var height = window.innerHeight;
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      }

      function onKeyDown(args) {
        if (args.code === "Space") {
          usePolyfill = false;
          vrDisplay = null;
          requestPresent();
          log('Animate');
        }
      }

      function log(comment) {
        if (usePolyfill) { comment += ' (Polyfill)' }
        logger.textContent = comment;
        if (comment.toLowerCase().indexOf('fail') > -1) {
          logger.className = 'fail';
        } else {
          logger.className = 'output';
        }
      }

      function countDown() {
        var count = +counter.textContent;
        if (count > 0) {
          counter.textContent = --count;
          return true;
        }
        counter.textContent = 0;
        return false;
      }
    })();
    </script>
  </body>
</html>
